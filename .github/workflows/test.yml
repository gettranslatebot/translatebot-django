name: Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: "3.12"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install ruff

    - name: Run Ruff linter
      run: ruff check .

    - name: Run Ruff formatter check
      run: ruff format --check .

  test:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.9", "3.10", "3.11", "3.12", "3.13", "3.14"]
        django-version: ["4.2", "5.0", "5.1", "5.2", "6"]
        exclude:
          # Django 5.0+ requires Python 3.10+
          - python-version: "3.9"
            django-version: "5.0"
          - python-version: "3.9"
            django-version: "5.1"
          - python-version: "3.9"
            django-version: "5.2"
          - python-version: "3.9"
            django-version: "6"
          - python-version: "3.10"
            django-version: "6"
          - python-version: "3.11"
            django-version: "6"

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v6
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install "Django~=${{ matrix.django-version }}.0"
        pip install -e ".[dev]"

    - name: Run tests
      env:
        PYTHONPATH: .
      run: |
        pytest -v --cov=translatebot_django --cov-report=xml --cov-report=term
    - name: Upload coverage to Codecov
      if: matrix.python-version == '3.14' && matrix.django-version == '6'
      uses: codecov/codecov-action@v5
      with:
        files: ./coverage.xml
        token: ${{ secrets.CODECOV_TOKEN }}
        fail_ci_if_error: false
